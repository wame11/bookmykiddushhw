<script>
// === CORS PROXY + DIRECT SCRIPT URL ===
const PROXY_URL = "https://corsproxy.io/?";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVdH1lwlVYi9EYXwyw6Lt4I8iYGzLjKTr_k1QLS2s3_f1XOdyWbYu5a6T26Hyka72Z/exec";

const FESTIVALS = new Set([
  "2025-04-13","2025-04-14","2025-04-19","2025-04-20","2025-06-02","2025-06-03",
  "2025-09-23","2025-09-24","2025-10-07","2025-10-08","2025-10-14","2025-10-15"
]);

let bookings = [];
let selected = null;
let viewDate = new Date();
let userEmail = null;

const grid = document.getElementById("grid");
const monthLabel = document.getElementById("monthLabel");
const formBox = document.getElementById("formBox");
const bookingsList = document.getElementById("bookingsList");
const loading = document.getElementById("loading");

const pad = n => n < 10 ? "0" + n : n;
const toISO = d => d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate());
const startOfMonth = d => new Date(d.getFullYear(), d.getMonth(), 1);
const addMonths = (d, m) => { const x = new Date(d); x.setMonth(x.getMonth() + m); return x; };

function getMatrix(v) {
  const s = startOfMonth(v);
  const offset = (s.getDay() + 6) % 7;
  let c = new Date(s);
  c.setDate(c.getDate() - offset);
  const out = [];
  for (let w = 0; w < 6; w++) {
    const r = [];
    for (let d = 0; d < 7; d++) {
      r.push(new Date(c));
      c.setDate(c.getDate() + 1);
    }
    out.push(r);
  }
  return out;
}

function isSelectable(d) {
  const today = toISO(new Date());
  const iso = toISO(d);
  if (iso < today) return false;
  return d.getDay() === 6 || FESTIVALS.has(iso);
}

// === FETCH BOOKINGS FROM SHEET (VIA PROXY) ===
async function fetchBookings() {
  loading.style.display = "block";
  try {
    const res = await fetch(PROXY_URL + SCRIPT_URL);
    const data = await res.json();
    bookings = Array.isArray(data) ? data : [];
    localStorage.setItem("kiddushBookings", JSON.stringify(bookings));
  } catch (err) {
    console.error("GET error:", err);
    const saved = localStorage.getItem("kiddushBookings");
    bookings = saved ? JSON.parse(saved) : [];
  }
  loading.style.display = "none";
  renderCalendar();
  renderBookings();
  if (selected) renderForm(); // Re-render form in case date was booked by someone else
}

function renderCalendar() {
  monthLabel.textContent = viewDate.toLocaleString("en-GB", { month: "long", year: "numeric" });
  grid.innerHTML = "";

  for (const d of getMatrix(viewDate).flat()) {
    const iso = toISO(d);
    const booking = bookings.find(b => String(b.date) === iso);
    const taken = !!booking;
    const canSelect = isSelectable(d) && d.getMonth() === viewDate.getMonth() && !taken;

    const cell = document.createElement("button");
    cell.disabled = !canSelect;
    cell.className = "h-24 rounded-xl border flex flex-col items-center justify-center gap-1 " +
      (d.getMonth() !== viewDate.getMonth() ? "bg-gray-50 text-gray-400" :
      canSelect ? "bg-white hover:bg-indigo-50" : "bg-gray-100 text-gray-400");
    
    // Dim dates from other months
    if (d.getMonth() !== viewDate.getMonth()) {
        cell.style.opacity = "0.5";
    }

    cell.innerHTML = `
      <span class='text-base font-semibold'>${d.getDate()}</span>
      <span class='text-[11px]'>${iso}</span>
      ${taken
        ? `<span class='chip bg-red-100 text-red-700'>Booked</span>
           <span class='text-[10px] text-red-700'>${booking.name}</span>`
        : canSelect
          ? "<span class='chip bg-green-100 text-green-700'>Available</span>"
          : ""
      }
    `;

    if (canSelect) {
      cell.addEventListener("click", () => {
        selected = d;
        renderForm();
      });
    }
    grid.appendChild(cell);
  }
}

function renderForm() {
  if (!selected) {
    formBox.innerHTML = "<p>Select an available date to sponsor the Kiddush at <strong>Hadley Wood Shul</strong>.</p>";
    return;
  }

  const iso = toISO(selected);
  const taken = bookings.some(b => String(b.date) === iso);

  formBox.innerHTML = `
    <div class='flex items-center justify-between gap-3'>
      <h3 class='text-xl font-semibold'>${selected.toLocaleDateString('en-GB', {day: 'numeric', month: 'long', year: 'numeric'})}</h3>
      <button id='changeDate' class='text-sm underline'>Change</button>
    </div>

    ${taken ? "<p class='mt-3 p-3 bg-red-50 border text-red-800 text-sm'>This date is already booked. Please select another.</p>" : ""}

    <form id='bookingForm' class='mt-4 grid md:grid-cols-2 gap-4'>
      <div>
        <label class='block text-sm font-medium'>Full name</label>
        <input required name='name' class='mt-1 w-full rounded-xl border px-3 py-2'>
      </div>
      <div>
        <label class='block text-sm font-medium'>Email</label>
        <input required type='email' name='email' class='mt-1 w-full rounded-xl border px-3 py-2'>
      </div>
      <div>
        <label class='block text-sm font-medium'>Sponsorship Amount (£)</label>
        <input required type='number' min='1' step='0.01' name='amount' placeholder='e.g. 50.00' class='mt-1 w-full rounded-xl border px-3 py-2'>
      </div>
      <div>
        <label class='block text-sm font-medium'>Synagogue</label>
        <input disabled value='Hadley Wood Shul' class='mt-1 w-full rounded-xl border px-3 py-2 bg-gray-100 text-gray-600'>
      </div>
      <div class='md:col-span-2'>
        <label class='block text-sm font-medium'>Dedication (optional)</label>
        <input name='dedication' class='mt-1 w-full rounded-xl border px-3 py-2'>
      </div>
      <div class='md:col-span-2 flex flex-wrap items-center gap-3'>
        <button id="reserveBtn" type="submit" ${taken ? "disabled" : ""} class='px-5 py-3 rounded-xl text-white font-semibold bg-indigo-600 hover:bg-indigo-700 ${taken ? "opacity-50 cursor-not-allowed" : ""}'>
          Reserve date
        </button>
        <span id='savedMsg' class='text-sm hidden'>&nbsp;</span>
      </div>
    </form>
  `;

  document.getElementById("changeDate").onclick = () => {
    selected = null;
    renderForm();
  };

  const form = document.getElementById("bookingForm");
  if (form && !taken) {
    form.onsubmit = async e => {
      e.preventDefault();
      const fd = new FormData(form);
      const rec = {
        date: iso,
        name: fd.get("name"),
        email: fd.get("email"),
        amount: parseFloat(fd.get("amount")).toFixed(2),
        dedication: fd.get("dedication") || "",
        synagogue: "Hadley Wood Shul"
      };
      userEmail = rec.email;

      const savedMsg = document.getElementById("savedMsg");
      savedMsg.textContent = "Saving...";
      savedMsg.className = 'text-sm text-gray-700'; // Reset classes

      try {
        // *** FIX: POST must use the proxy to read the response ***
        const res = await fetch(PROXY_URL + SCRIPT_URL, {
          method: "POST",
          // mode: 'no-cors', // <-- REMOVED
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(rec)
        });

        // Check for network errors
        if (!res.ok) {
          throw new Error(`Server returned ${res.status}`);
        }
        
        // Check for application errors from Apps Script
        const data = await res.json();
        if (data.status !== "success") {
          // Show specific error, e.g., "Date already booked"
          throw new Error(data.message || "Failed to save.");
        }

        savedMsg.innerHTML = "Saved + Email Sent";
        savedMsg.classList.add("text-green-600");

        // No need to push locally. Let fetchBookings get the new data.
        setTimeout(() => {
          selected = null;
          fetchBookings(); // Reload from sheet (which is now updated)
        }, 1500);

      } catch (err) {
        // Display the actual error
        savedMsg.textContent = "Error: " + err.message;
        savedMsg.classList.add("text-red-600");
      }
    };
  }
}

function renderBookings() {
  bookingsList.innerHTML = bookings.length
    ? bookings.map(b => {
        const canRemove = userEmail && userEmail === b.email;
        return `
          <div class='p-4 rounded-xl border bg-white flex justify-between items-start'>
            <div>
              <p class='font-semibold'>${new Date(b.date).toLocaleDateString('en-GB', {day: 'numeric', month: 'long', year: 'numeric'})} — ${b.name}</p>
              <p class='text-sm text-indigo-600 font-medium'>£${b.amount}</p>
              ${b.dedication ? `<p class='text-sm text-gray-600'>${b.dedication}</p>` : ""}
            </div>
            ${canRemove
              ? `<button class='px-3 py-1 rounded border text-xs hover:bg-gray-50' onclick='deleteBooking("${b.date}")'>Remove</button>`
              : ""}
          </div>`;
      }).join("")
    : "<div class='p-4 rounded-xl bg-gray-50 border text-sm text-gray-600'>No bookings yet.</div>";
}

async function deleteBooking(date) {
  if (!confirm("Remove your booking for " + date + "?")) return;
  try {
    // *** FIX: GET with parameters must also use the proxy ***
    const res = await fetch(PROXY_URL + SCRIPT_URL + "?action=delete&date=" + date);
    // { mode: 'no-cors' } is removed

    if (!res.ok) {
        throw new Error(`Server returned ${res.status}`);
    }

    const data = await res.json();
    if (data.status !== "success") {
        throw new Error(data.message || "Delete failed");
    }
    
    // Success! Now reload the fresh data from the sheet.
    fetchBookings();

  } catch (err) {
    alert("Delete failed: " + err.message);
  }
}

document.getElementById("prevBtn").onclick = () => { viewDate = addMonths(viewDate, -1); renderCalendar(); };
document.getElementById("nextBtn").onclick = () => { viewDate = addMonths(viewDate, 1); renderCalendar(); };

// Load from sheet + localStorage fallback
fetchBookings();
</script>
