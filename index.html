<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Book My Kiddush — Hadley Wood Shul</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(to bottom,#eef2ff,white); }
        .card { background: rgba(255,255,255,0.85); backdrop-filter: saturate(1.2) blur(2px); -webkit-backdrop-filter: saturate(1.2) blur(2px); }
        .chip { font-size: 10px; padding: .125rem .5rem; border-radius: 9999px; }
        #loading { display: none; text-align: center; padding: 1rem; color: #555; }
    </style>
</head>
<body class="text-gray-900">

    <header class="sticky top-0 z-40 bg-white bg-opacity-70 backdrop-filter backdrop-blur border-b">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <a href="#home" class="font-black tracking-tight text-xl">Book My Kiddush</a>
            <nav class="hidden md:flex gap-6 text-sm font-medium">
                <a href="#faq" class="hover:text-indigo-600">Key Information</a>
                <a href="#calendar" class="hover:text-indigo-600">Calendar</a>
                <a href="#contact" class="hover:text-indigo-600">Contact</a>
            </nav>
            <a href="#calendar" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700">Sponsor</a>
        </div>
    </header>

    <main id="home" class="relative overflow-hidden">
        <section class="max-w-6xl mx-auto px-4 py-16 md:py-24 grid md:grid-cols-2 gap-12 items-center">
            <div>
                <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">Reserve your Kiddush date</h1>
                <p class="mt-4 text-lg text-gray-700">
                    Select an available <strong>Shabbat</strong> or <strong>Festival</strong> date to sponsor the Kiddush at <strong>Hadley Wood Shul</strong>.
                </p>
                <div class="mt-6 flex flex-wrap gap-3">
                    <a href="#calendar" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Open Calendar</a>
                </div>
            </div>
            <div class="p-4">
                <div class="aspect-video rounded-2xl border shadow-lg bg-white grid place-items-center">
                    <p class="text-gray-600">Book your Kiddush date quickly and easily.</p>
                </div>
            </div>
        </section>
    </main>

    <section id="faq" class="max-w-6xl mx-auto px-4 py-16 border-t">
        <h2 class="text-2xl md:text-3xl font-bold mb-6">Key Information</h2>
        <div class="space-y-6 text-gray-700">
            <div><h3 class="font-semibold text-lg text-indigo-700">How do I book a Kiddush?</h3><p class="mt-1">Scroll down to the calendar, choose an available date, select your preferred sponsorship package, and complete the booking form.</p></div>
            <div><h3 class="font-semibold text-lg text-indigo-700">What about Bar/Bat Mitzvahs?</h3><p class="mt-1">By all means book your kiddush but please be aware there is a separate process for booking bar/bat mizvah celebrations through the office.</p></div>
            <div><h3 class="font-semibold text-lg text-indigo-700">Can I cancel or change my booking?</h3><p class="mt-1">Yes — if you booked with your email, you can remove your booking from the “Upcoming bookings” list, or contact the office for help.</p></div>
            <div><h3 class="font-semibold text-lg text-indigo-700">Who can see the amount I've sponsored?</h3><p class="mt-1">Only the Shul office.</p></div>
            <div><h3 class="font-semibold text-lg text-indigo-700">What if a date says “Booked”?</h3><p class="mt-1">That means it’s already taken — please select another available Shabbat or Festival date.</p></div>
        </div>
    </section>

    <section id="calendar" class="max-w-6xl mx-auto px-4 py-16 border-t">
        <h2 class="text-2xl md:text-3xl font-bold">Choose your date</h2>
        <p class="mt-2 text-gray-700">Only Saturdays and preset Festivals are available.</p>

        <div id="loading" class="mt-4">Loading calendar...</div>

        <div class="mt-6 grid md:grid-cols-2 gap-8 items-start">
            <div class="card p-4 rounded-2xl border shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <button id="prevBtn" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Prev</button>
                    <h3 id="monthLabel" class="text-lg font-semibold"></h3>
                    <button id="nextBtn" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Next</button>
                </div>
                <div class="grid grid-cols-7 gap-2 text-sm text-center font-medium text-gray-600">
                    <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
                </div>
                <div id="grid" class="grid grid-cols-7 gap-2 mt-3"></div>
            </div>

            <div class="space-y-6">
                <div id="formBox" class="card p-6 rounded-2xl border shadow-sm text-sm text-gray-700">
                    <p>Select an available date to sponsor the Kiddush at <strong>Hadley Wood Shul</strong>.</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">Upcoming bookings</h3>
                    <div id="bookingsList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="contact" class="max-w-6xl mx-auto px-4 py-16 border-t">
        <h2 class="text-2xl md:text-3xl font-bold mb-4">Contact</h2>
        <p class="text-gray-700 text-lg">
            For any questions or assistance, please contact
            <a href="mailto:office@hwjc.org.uk" class="text-indigo-600 hover:underline font-medium">office@hwjc.org.uk</a>.
        </p>
    </section>

    <script>
        /*
          Client config:
          - Set SCRIPT_URL to your deployed Apps Script web app URL (recommended).
          - If you must use a proxy, set USE_PROXY = true and ensure PROXY_URL works for POSTs.
        */
        const USE_PROXY = true;
        const PROXY_URL = "https://corsproxy.io/?";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGSbPyBZdddJNl6PzUHMsI2W-NoUDxAfGyQ-lKKOMcVnIiGtXiLfzp8YFM3IHpDZWQ/exec"; // <-- REPLACE with your deployed web app URL

        const FESTIVALS = new Set([
            "2025-04-13","2025-04-14","2025-04-19","2025-04-20",
            "2025-06-02","2025-06-03",
            "2025-09-23","2025-09-24",
            "2025-10-07","2025-10-08",
            "2025-10-14","2025-10-15"
        ]);

        let bookings = [];
        let selected = null;
        let viewDate = new Date();
        let userEmail = localStorage.getItem("kiddushUserEmail") || null;

        const grid = document.getElementById("grid");
        const monthLabel = document.getElementById("monthLabel");
        const formBox = document.getElementById("formBox");
        const bookingsList = document.getElementById("bookingsList");
        const loading = document.getElementById("loading");

        function endpoint(path = "") {
            const base = USE_PROXY ? (PROXY_URL + SCRIPT_URL) : SCRIPT_URL;
            return path ? (base + path) : base;
        }

        function makeDate(y,m,d){ return new Date(Date.UTC(y,m-1,d,12)); }
        function formatISO(y,m,d){ return `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`; }
        function parseISODateString(iso){ if(!iso) return null; const [y,m,d] = iso.trim().split("-").map(Number); if(!y||!m||!d) return null; return makeDate(y,m,d); }

        function normaliseBackendDate(val){
            if (val === null || val === undefined) return "";
            const s = String(val).trim();
            if (!s) return "";
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
            if (/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.slice(0,10);
            const cleaned = s.startsWith("'") ? s.substring(1).trim() : s;
            const uk = cleaned.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (uk) {
                const day = Number(uk[1]), month = Number(uk[2]), year = Number(uk[3]);
                if (year && month>=1 && month<=12 && day>=1 && day<=31) return formatISO(year,month,day);
            }
            const d = new Date(cleaned);
            if (!isNaN(d)) return formatISO(d.getUTCFullYear(), d.getUTCMonth()+1, d.getUTCDate());
            return "";
        }

        async function fetchBookings(){
            loading.style.display = "block";
            try {
                const res = await fetch(endpoint());
                if(!res.ok) throw new Error("HTTP " + res.status);
                const data = await res.json();
                bookings = Array.isArray(data) ? data.map(b => ({ ...b, date: normaliseBackendDate(b.date) })).filter(b => b.date) : [];
                localStorage.setItem("kiddushBookings", JSON.stringify(bookings));
            } catch(e){
                console.error("Fetch failed:", e);
                const saved = localStorage.getItem("kiddushBookings");
                bookings = saved ? JSON.parse(saved) : [];
            }
            loading.style.display = "none";
            renderCalendar();
            renderBookings();
            if (selected) renderForm();
        }

        function renderCalendar(){
            monthLabel.textContent = viewDate.toLocaleString("en-GB", { month: "long", year: "numeric" });
            grid.innerHTML = "";
            const y = viewDate.getFullYear(), m = viewDate.getMonth()+1;
            const todayMid = makeDate(new Date().getFullYear(), new Date().getMonth()+1, new Date().getDate());

            getCalendarDays(y,m).forEach(d=>{
                const cy = d.getUTCFullYear(), cm = d.getUTCMonth()+1, cd = d.getUTCDate();
                const iso = formatISO(cy,cm,cd);
                const thisMonth = cm === m;
                const taken = bookings.some(b => b.date === iso);
                const isPast = d < todayMid;
                const selectable = isSaturdayOrFestival(d) && thisMonth && !taken && !isPast;

                const cell = document.createElement("button");
                cell.disabled = !selectable;
                cell.className = `aspect-square rounded-xl border flex flex-col items-center justify-center gap-1 transition ${selectable ? "bg-white hover:bg-indigo-50 cursor-pointer" : "bg-gray-50 text-gray-400"}`;

                cell.innerHTML = `<span class="text-base font-semibold ${thisMonth ? "text-gray-900" : "text-gray-400"}">${cd}</span>
                ${taken ? `<span class="chip bg-red-100 text-red-700">Booked</span>` :
                    selectable ? `<span class="chip bg-green-100 text-green-700">Available</span>` :
                    isSaturdayOrFestival(d) && !thisMonth ? `<span class="chip bg-yellow-100 text-yellow-700">Other Month</span>` : ""}`;
                if (selectable) cell.onclick = () => { selected = d; renderForm(); renderCalendar(); };
                if (selected && formatISO(selected.getUTCFullYear(), selected.getUTCMonth()+1, selected.getUTCDate()) === iso) {
                    cell.classList.add("ring-4","ring-indigo-400","ring-offset-2");
                }
                grid.appendChild(cell);
            });
        }

        function getCalendarDays(year, month){
            const first = makeDate(year, month, 1);
            const startOffset = (first.getUTCDay() + 6) % 7;
            const startDay = 1 - startOffset;
            const days = [];
            for (let i=0;i<42;i++) days.push(new Date(Date.UTC(year, month-1, startDay+i, 12)));
            return days;
        }

        function isSaturdayOrFestival(d){
            return d.getUTCDay() === 6 || FESTIVALS.has(formatISO(d.getUTCFullYear(), d.getUTCMonth()+1, d.getUTCDate()));
        }

        function renderBookings(){
            if (!bookings.length) { bookingsList.innerHTML = `<div class="p-4 rounded-xl bg-gray-50 border text-sm text-gray-600">No bookings yet.</div>`; return; }
            const todayMid = makeDate(new Date().getFullYear(), new Date().getMonth()+1, new Date().getDate());
            const upcoming = bookings.map(b => ({ ...b, dateObj: parseISODateString(b.date) })).filter(b => b.dateObj && b.dateObj >= todayMid).sort((a,b) => a.date.localeCompare(b.date));
            bookingsList.innerHTML = upcoming.length ? upcoming.map(b => {
                const nice = b.dateObj.toLocaleDateString("en-GB", { timeZone: "Europe/London", weekday: "long", day: "numeric", month: "long", year: "numeric" });
                const canRemove = userEmail && userEmail.toLowerCase() === (b.email||"").toLowerCase();
                return `<div class="p-4 rounded-xl border bg-white flex justify-between items-start"><div><p class="font-semibold">${nice} — ${b.name}</p>${b.dedication?`<p class="text-sm text-gray-600">${b.dedication}</p>`:""}</div>${canRemove?`<button class="px-3 py-1 rounded border text-xs hover:bg-red-50 text-red-600" onclick='deleteBooking("${b.date}")'>Remove</button>`:""}</div>`;
            }).join("") : `<div class="p-4 rounded-xl bg-gray-50 border text-sm text-gray-600">No upcoming bookings.</div>`;
        }

        function renderForm(){
            if (!selected) { formBox.innerHTML = `<p>Select an available date to sponsor the Kiddush at <strong>Hadley Wood Shul</strong>.</p>`; return; }
            const iso = formatISO(selected.getUTCFullYear(), selected.getUTCMonth()+1, selected.getUTCDate());
            const nice = selected.toLocaleDateString("en-GB", { timeZone: "Europe/London", weekday: "long", day: "numeric", month: "long", year: "numeric" });

            formBox.innerHTML = `
                <div class="flex items-center justify-between gap-3 mb-4">
                    <h3 class="text-xl font-semibold">${nice}</h3>
                    <button id="changeDate" class="text-sm underline text-indigo-600 hover:text-indigo-700">Change Date</button>
                </div>
                <form id="bookingForm" class="grid md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">Full name</label><input required name="name" class="mt-1 w-full rounded-xl border px-3 py-2"></div>
                    <div><label class="block text-sm font-medium">Email</label><input required type="email" name="email" class="mt-1 w-full rounded-xl border px-3 py-2"></div>
                    <div><label class="block text-sm font-medium">Sponsorship Package</label>
                        <select required id="sponsorshipAmount" class="mt-1 w-full rounded-xl border px-3 py-2">
                            <option value="">Select a package</option>
                            <option value="200.00">Standard (£200)</option>
                            <option value="325.00">Premium (£325)</option>
                            <option value="To be discussed with Chantel">Special (Contact Office)</option>
                        </select>
                    </div>
                    <div><label class="block text-sm font-medium">Synagogue</label><input disabled value="Hadley Wood Shul" class="mt-1 w-full rounded-xl border px-3 py-2 bg-gray-100"></div>
                    <div class="md:col-span-2"><label class="block text-sm font-medium">Dedication (optional)</label><input name="dedication" class="mt-1 w-full rounded-xl border px-3 py-2"></div>
                    <div class="md:col-span-2 flex items-center gap-3"><button id="reserveBtn" type="submit" class="px-6 py-3 rounded-xl bg-indigo-600 text-white">Reserve date</button><span id="savedMsg" class="text-sm hidden"></span></div>
                </form>
            `;
            const emailInput = formBox.querySelector('input[name="email"]');
            if (emailInput && userEmail) emailInput.value = userEmail;

            document.getElementById("changeDate").onclick = () => { selected = null; renderForm(); renderCalendar(); };

            document.getElementById("bookingForm").onsubmit = async e => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const amount = document.getElementById("sponsorshipAmount").value;
                if (!amount) return alert("Please select a sponsorship package.");

                const btn = document.getElementById("reserveBtn");
                btn.disabled = true; btn.textContent = "Reserving...";

                const payload = {
                    date: iso,
                    name: fd.get("name").trim(),
                    email: fd.get("email").toLowerCase().trim(),
                    amount: amount === "To be discussed with Chantel" ? amount : parseFloat(amount).toFixed(2),
                    dedication: fd.get("dedication").trim(),
                    synagogue: "Hadley Wood Shul"
                };

                userEmail = payload.email;
                localStorage.setItem("kiddushUserEmail", userEmail);
                const msg = document.getElementById("savedMsg");
                msg.textContent = "Saving..."; msg.classList.remove("hidden");

                try {
                    const res = await fetch(endpoint(), {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    const text = await res.text();
                    console.log("=== RAW SERVER RESPONSE ===", text); // This will show the truth!

                    let json = null;
                    try { json = JSON.parse(text); } catch(e) { 
                        console.error("Parse failed:", e, "Raw:", text); 
                    }
                    if (!res.ok) throw new Error("HTTP " + res.status + (json?.message ? (": "+json.message) : ""));
                    if (json && json.status === "error") throw new Error(json.message || "Server error");

                    msg.textContent = "Booking confirmed!"; msg.classList.remove("hidden"); msg.classList.add("text-green-600");
                    formBox.innerHTML = `<div class="p-6 rounded-xl bg-green-50 text-green-800 text-center">Booking for <strong>${nice}</strong> reserved successfully!</div>`;
                    selected = null;
                    localStorage.removeItem("kiddushBookings");
                    setTimeout(fetchBookings, 800);
                } catch (err) {
                    console.error("Reservation failed:", err);
                    msg.textContent = "Error — please try again or contact office."; msg.classList.remove("hidden"); msg.classList.add("text-red-600");
                    btn.disabled = false; btn.textContent = "Reserve date";
                }
            };
        }

        async function deleteBooking(dateIso){
            if (!userEmail) return alert("Email required to remove booking.");
            const b = bookings.find(x => x.date === dateIso);
            if (!b || (b.email||"").toLowerCase() !== userEmail.toLowerCase()) return alert("You can only remove your own bookings.");
            const nice = parseISODateString(dateIso)?.toLocaleDateString("en-GB", { timeZone:"Europe/London", weekday:"long", day:"numeric", month:"long", year:"numeric"}) || dateIso;
            if (!confirm(`Remove your booking for ${nice}?`)) return;
            try {
                const url = endpoint(`?action=delete&date=${encodeURIComponent(dateIso)}&email=${encodeURIComponent(userEmail)}`);
                const res = await fetch(url, { method: "GET" });
                if (!res.ok) throw new Error("HTTP " + res.status);
                const text = await res.text();
                let json = null;
                try { json = JSON.parse(text); } catch (e) {}
                if (json && json.status === "error") throw new Error(json.message || "Delete failed");
                localStorage.removeItem("kiddushBookings");
                await fetchBookings();
                alert("Booking removed.");
            } catch (err) {
                console.error("Delete failed:", err);
                alert("Failed to remove. Please contact office.");
            }
        }

        document.getElementById("prevBtn").onclick = () => { viewDate.setMonth(viewDate.getMonth() - 1); renderCalendar(); };
        document.getElementById("nextBtn").onclick = () => { viewDate.setMonth(viewDate.getMonth() + 1); renderCalendar(); };

        fetchBookings();
    </script>
</body>
</html>
