<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book My Kiddush — Hadley Wood Shul</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(to bottom,#eef2ff,white); }
    .card { background: rgba(255,255,255,0.85); backdrop-filter: saturate(1.2) blur(2px); -webkit-backdrop-filter: saturate(1.2) blur(2px); }
    .chip { font-size: 10px; padding: .125rem .5rem; border-radius: 9999px; }
    #loading { display: none; text-align: center; padding: 1rem; color: #555; }
  </style>
</head>
<body class="text-gray-900">

<header class="sticky top-0 z-40 bg-white bg-opacity-70 backdrop-filter backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="#home" class="font-black tracking-tight text-xl">Book My Kiddush</a>
    <nav class="hidden md:flex gap-6 text-sm font-medium">
      <a href="#faq" class="hover:text-indigo-600">Key Information</a>
      <a href="#calendar" class="hover:text-indigo-600">Calendar</a>
      <a href="#contact" class="hover:text-indigo-600">Contact</a>
    </nav>
    <a href="#calendar" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700">Sponsor</a>
  </div>
</header>

<main id="home" class="relative overflow-hidden">
  <section class="max-w-6xl mx-auto px-4 py-16 md:py-24 grid md:grid-cols-2 gap-12 items-center">
    <div>
      <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">Reserve your Kiddush date</h1>
      <p class="mt-4 text-lg text-gray-700">
        Select an available <strong>Shabbat</strong> or <strong>Festival</strong> date to sponsor the Kiddush at <strong>Hadley Wood Shul</strong>.
      </p>
      <div class="mt-6 flex flex-wrap gap-3">
        <a href="#calendar" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Open Calendar</a>
      </div>
    </div>
    <div class="p-4">
      <div class="aspect-video rounded-2xl border shadow-lg bg-white grid place-items-center">
        <p class="text-gray-600">Book your Kiddush date quickly and easily.</p>
      </div>
    </div>
  </section>
</main>

<section id="faq" class="max-w-6xl mx-auto px-4 py-16 border-t">
  <h2 class="text-2xl md:text-3xl font-bold mb-6">Key Information</h2>
  <div class="space-y-6 text-gray-700">
    <div><h3 class="font-semibold text-lg text-indigo-700">How do I book a Kiddush?</h3><p class="mt-1">Scroll down to the calendar, choose an available date, select your preferred sponsorship package, and complete the booking form.</p></div>
    <div><h3 class="font-semibold text-lg text-indigo-700">What about Bar/Bat Mitzvahs?</h3><p class="mt-1">By all means book your kiddush but please be aware there is a separate process for booking bar/bat mizvah celebrations through the office.</p></div>
    <div><h3 class="font-semibold text-lg text-indigo-700">Can I cancel or change my booking?</h3><p class="mt-1">Yes — if you booked with your email, you can remove your booking from the “Upcoming bookings” list, or contact the office for help.</p></div>
    <div><h3 class="font-semibold text-lg text-indigo-700">Who can see the amount I've sponsored?</h3><p class="mt-1">Only the Shul office.</p></div>
    <div><h3 class="font-semibold text-lg text-indigo-700">What if a date says “Booked”?</h3><p class="mt-1">That means it’s already taken — please select another available Shabbat or Festival date.</p></div>
  </div>
</section>

<section id="calendar" class="max-w-6xl mx-auto px-4 py-16 border-t">
  <h2 class="text-2xl md:text-3xl font-bold">Choose your date</h2>
  <p class="mt-2 text-gray-700">Only Saturdays and preset Festivals are available.</p>

  <div id="loading">Loading calendar...</div>

  <div class="mt-6 grid md:grid-cols-2 gap-8 items-start">
    <div class="card p-4 rounded-2xl border shadow-sm">
      <div class="flex items-center justify-between">
        <button id="prevBtn" class="px-3 py-2 rounded-lg border hover:bg-gray-50">Prev</button>
        <h3 id="monthLabel" class="text-lg font-semibold"></h3>
        <button id="nextBtn" class="px-3 py-2 rounded-lg border hover:bg-gray-50">Next</button>
      </div>
      <div class="grid grid-cols-7 gap-2 mt-4 text-sm text-center font-medium text-gray-600">
        <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
      </div>
      <div id="grid" class="grid grid-cols-7 gap-2 mt-2"></div>
    </div>

    <div class="space-y-6">
      <div id="formBox" class="card p-6 rounded-2xl border shadow-sm text-sm text-gray-700">
        <p>Select an available date to sponsor the Kiddush at <strong>Hadley Wood Shul</strong>.</p>
      </div>
      <div>
        <h3 class="text-lg font-semibold mb-2">Upcoming bookings</h3>
        <div id="bookingsList"></div>
      </div>
    </div>
  </div>
</section>

<section id="contact" class="max-w-6xl mx-auto px-4 py-16 border-t">
  <h2 class="text-2xl md:text-3xl font-bold mb-4">Contact</h2>
  <p class="text-gray-700 text-lg">
    For any questions or assistance, please contact
    <a href="mailto:office@hwjc.org.uk" class="text-indigo-600 hover:underline font-medium">office@hwjc.org.uk</a>.
  </p>
</section>

<script>
// CONFIG
const PROXY_URL = "https://corsproxy.io/?";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzqgikgNlCS59SzVoAZVY12QSvU716m869db2Y5IoriL4Q8-2et1PB3OYf7IiXfjxim/exec";

// Festival dates in YYYY-MM-DD format (ISO)
const FESTIVALS = new Set([
  "2025-04-13","2025-04-14","2025-04-19","2025-04-20", // Pesach
  "2025-06-02","2025-06-03", // Shavuot
  "2025-09-23","2025-09-24", // Rosh Hashanah
  "2025-10-07","2025-10-08", // Succot
  "2025-10-14","2025-10-15" // Shemini Atzeret / Simchat Torah
]);

let bookings = [];
let selected = null;
let viewDate = new Date();
let userEmail = null;

const grid = document.getElementById("grid");
const monthLabel = document.getElementById("monthLabel");
const formBox = document.getElementById("formBox");
const bookingsList = document.getElementById("bookingsList");
const loading = document.getElementById("loading");

// ---------- DATE HELPERS ----------

// Creates a Date object for a specific day at noon UTC,
// preventing timezone issues with date comparisons.
function makeDate(y, m, d) { return new Date(Date.UTC(y, m - 1, d, 12)); }

// Formats a date component into standard YYYY-MM-DD (ISO)
function formatISO(y, m, d) {
  return `${y}-${m.toString().padStart(2, "0")}-${d.toString().padStart(2, "0")}`;
}

// Function to safely normalise a date string to YYYY-MM-DD format
function normaliseBackendDate(dateVal) {
  if (typeof dateVal !== 'string') return "";
  const s = dateVal.trim();
  if (!s) return "";

  const d = new Date(s);
  if (!isNaN(d.getTime())) {
    // Use UTC methods to ensure the date is the *intended* date, not a local timezone date
    return formatISO(
      d.getUTCFullYear(),
      d.getUTCMonth() + 1,
      d.getUTCDate()
    );
  }

  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  
  const m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
  if (m) {
    let day = Number(m[1]);
    let month = Number(m[2]);
    let year = Number(m[3]);
    if (year < 100) year += 2000;
    return formatISO(year, month, day);
  }

  return s;
}

// ---------- FETCH BOOKINGS ----------

async function fetchBookings() {
  loading.style.display = "block";
  let fetchError = false;
  let fetchedData = [];

  try {
    const res = await fetch(PROXY_URL + SCRIPT_URL);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();
    
    fetchedData = Array.isArray(data)
      ? data.map(b => ({ ...b, date: normaliseBackendDate(b.date) }))
      : [];
      
    // IMPORTANT: Update local storage only on successful fetch
    localStorage.setItem("kiddushBookings", JSON.stringify(fetchedData));
    bookings = fetchedData;

  } catch (e) {
    console.error("Failed to fetch bookings:", e);
    fetchError = true;
    const saved = localStorage.getItem("kiddushBookings");
    bookings = saved
      ? JSON.parse(saved).map(function(b) {
          return {
              ...b,
              date: normaliseBackendDate(b.date)
          };
      })
      : [];
    if (bookings.length > 0) {
        console.warn("Using cached bookings due to fetch failure.");
    } else if (fetchError) {
        loading.textContent = "Could not load bookings. Please refresh or try later.";
        loading.style.color = "#dc2626"; // red
    }
  }


  loading.style.display = "none";
  renderCalendar();
  renderBookings();
  if (selected) renderForm();
}

// ---------- CALENDAR RENDER ----------

function renderCalendar() {
  monthLabel.textContent = viewDate.toLocaleString("en-GB", {
    month: "long",
    year: "numeric"
  });
  grid.innerHTML = "";

  const y = viewDate.getFullYear();
  const m = viewDate.getMonth() + 1;

  const today = new Date();
  // Today's date normalized to noon UTC for reliable comparison
  const todayMid = makeDate(today.getFullYear(), today.getMonth() + 1, today.getDate());

  getCalendarDays(y, m).forEach(d => {
    const cy = d.getUTCFullYear();
    const cm = d.getUTCMonth() + 1;
    const cd = d.getUTCDate();
    const iso = formatISO(cy, cm, cd);
    const thisMonth = cm === m;

    const booking = bookings.find(b => b.date === iso);
    const taken = !!booking;
    // Check if the current calendar day is before today (noon UTC)
    const isPast = d < todayMid; 

    const selectable =
      isSaturdayOrFestival(d) && thisMonth && !taken && !isPast;

    const cell = document.createElement("button");
    cell.disabled = !selectable;
    cell.className =
      "h-24 rounded-xl border flex flex-col items-center justify-center gap-1 " +
      (selectable
        ? "bg-white hover:bg-indigo-50 cursor-pointer transition duration-150"
        : "bg-gray-50 text-gray-400");

    cell.innerHTML = `
      <span class='text-base font-semibold ${thisMonth ? 'text-gray-900' : 'text-gray-400'}'>${cd}</span>
      <span class='text-[11px] text-gray-500'>${iso}</span>
      ${
        taken
          ? "<span class='chip bg-red-100 text-red-700'>Booked</span>"
          : selectable
          ? "<span class='chip bg-green-100 text-green-700'>Available</span>"
          : (isSaturdayOrFestival(d) && !thisMonth) 
          ? "<span class='chip bg-yellow-100 text-yellow-700'>Other Month</span>"
          : ""
      }
    `;

    if (selectable) {
      cell.onclick = () => {
        selected = d;
        renderForm();
      };
    }
    
    // Highlight the selected date
    if (selected && formatISO(selected.getUTCFullYear(), selected.getUTCMonth() + 1, selected.getUTCDate()) === iso) {
        cell.classList.add("ring-4", "ring-indigo-300", "ring-offset-2");
    }

    grid.appendChild(cell);
  });
}

function getCalendarDays(year, month) {
    const first = makeDate(year, month, 1);
    // getUTCDay(): 0=Sun, 1=Mon, 2=Tue... 6=Sat
    // We want Monday (1) to be offset 0, so we use (day + 6) % 7
    const startOffset = (first.getUTCDay() + 6) % 7; 
    const startDay = 1 - startOffset; // Day number of the first cell

    const days = [];
    for (let i = 0; i < 42; i++) {
        let d = new Date(Date.UTC(year, month - 1, startDay + i, 12)); 
        days.push(d);
    }

    return days;
}

function isSaturdayOrFestival(d) {
  const y = d.getUTCFullYear();
  const m = d.getUTCMonth() + 1;
  const day = d.getUTCDate();
  const iso = formatISO(y, m, day);
  // Saturday is day 6 in UTC (0=Sun, 1=Mon... 6=Sat)
  return d.getUTCDay() === 6 || FESTIVALS.has(iso);
}

// ---------- UPCOMING BOOKINGS ----------

function renderBookings() {
  if (!bookings.length) {
    bookingsList.innerHTML =
      "<div class='p-4 rounded-xl bg-gray-50 border text-sm text-gray-600'>No bookings yet.</div>";
    return;
  }
  
  // Filter out past bookings and sort by date
  const upcomingBookings = bookings
    .filter(b => {
        const [y, m, d] = b.date.split("-").map(Number);
        const bookingDate = makeDate(y, m, d);
        const today = new Date();
        const todayMid = makeDate(today.getFullYear(), today.getMonth() + 1, today.getDate());
        return bookingDate >= todayMid;
    })
    .sort((a, b) => a.date.localeCompare(b.date));


  bookingsList.innerHTML = upcomingBookings
    .map(b => {
      const iso = b.date;
      const [y, m, d] = iso.split("-").map(Number);
      const jsDate = makeDate(y, m, d);
      const nice = jsDate.toLocaleDateString("en-GB", {
        weekday: "long",
        day: "numeric",
        month: "long",
        year: "numeric"
      });

      // Simple email check for 'canRemove' functionality
      const canRemove = userEmail && userEmail.toLowerCase() === b.email.toLowerCase();

      return `
        <div class='p-4 rounded-xl border bg-white flex justify-between items-start'>
          <div>
            <p class='font-semibold'>${nice} — ${b.name}</p>
            ${
              b.dedication
                ? `<p class='text-sm text-gray-600'>${b.dedication}</p>`
                : ""
            }
          </div>
          ${
            canRemove
              ? `<button class='px-3 py-1 rounded border text-xs hover:bg-red-50 text-red-600'
                         onclick='deleteBooking("${iso}")'>Remove</button>`
              : ""
          }
        </div>`;
    })
    .join("");
    
    if (upcomingBookings.length === 0) {
         bookingsList.innerHTML =
          "<div class='p-4 rounded-xl bg-gray-50 border text-sm text-gray-600'>No upcoming bookings.</div>";
    }
}

// ---------- BOOKING FORM ----------

function renderForm() {
  if (!selected) {
    formBox.innerHTML =
      "<p>Select an available date to sponsor the Kiddush at <strong>Hadley Wood Shul</strong>.</p>";
    return;
  }

  const y = selected.getUTCFullYear();
  const m = selected.getUTCMonth() + 1;
  const d = selected.getUTCDate();
  const iso = formatISO(y, m, d);

  const nice = selected.toLocaleDateString("en-GB", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric"
  });

  formBox.innerHTML = `
    <div class='flex items-center justify-between gap-3'>
      <h3 class='text-xl font-semibold'>${nice}</h3>
      <button id='changeDate' class='text-sm underline text-indigo-600 hover:text-indigo-700'>Change Date</button>
    </div>
    <form id='bookingForm' class='mt-4 grid md:grid-cols-2 gap-4'>
      <div><label class='block text-sm font-medium'>Full name</label>
      <input required name='name' class='mt-1 w-full rounded-xl border px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500'></div>

      <div><label class='block text-sm font-medium'>Email</label>
      <input required type='email' name='email' class='mt-1 w-full rounded-xl border px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500'></div>

      <div>
        <label class='block text-sm font-medium'>Sponsorship Package</label>
        <select required name='amount' id='sponsorshipAmount'
         class='mt-1 w-full rounded-xl border px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500'>
          <option value=''>Select a package</option>
          <option value='200.00' data-label='Standard'>Standard (£200)</option>
          <option value='325.00' data-label='Premium'>Premium (£325)</option>
          <option value='To be discussed with Chantel' data-label='Special'>Special (Contact Office)</option>
        </select>
      </div>

      <div>
        <label class='block text-sm font-medium'>Synagogue</label>
        <input disabled value='Hadley Wood Shul'
         class='mt-1 w-full rounded-xl border px-3 py-2 bg-gray-100 text-gray-600'>
      </div>

      <div class='md:col-span-2'>
        <label class='block text-sm font-medium'>Dedication (optional)</label>
        <input name='dedication' class='mt-1 w-full rounded-xl border px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500'>
      </div>

      <div class='md:col-span-2 flex flex-wrap items-center gap-3'>
        <button id='reserveBtn' type='submit'
                class='px-5 py-3 rounded-xl text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150'>
          Reserve date
        </button>
        <span id='savedMsg' class='text-sm hidden'>&nbsp;</span>
      </div>
    </form>
  `;
    
  // Pre-fill email if known from previous booking
  const emailInput = document.querySelector("#bookingForm input[name='email']");
  if (emailInput && userEmail) {
      emailInput.value = userEmail;
  }


  document.getElementById("changeDate").onclick = () => {
    selected = null;
    renderForm();
    renderCalendar(); // Re-render calendar to remove selection highlight
  };

  const form = document.getElementById("bookingForm");
  if (form) {
    form.onsubmit = async e => {
      e.preventDefault();

      const fd = new FormData(form);
      const amountEl = document.getElementById("sponsorshipAmount");
      const amountValue = amountEl.value;
      const amountLabel =
        amountEl.selectedOptions[0].getAttribute("data-label") || amountValue;

      if (!amountValue) {
        alert("Please select a Sponsorship Package.");
        return;
      }
      
      const reserveBtn = document.getElementById("reserveBtn");
      reserveBtn.disabled = true;
      reserveBtn.textContent = "Reserving...";

      const rec = {
        date: iso,
        name: fd.get("name"),
        email: fd.get("email").toLowerCase(), // Normalize email
        amount:
          amountValue === "To be discussed with Chantel"
            ? amountValue
            : parseFloat(amountValue).toFixed(2),
        dedication: fd.get("dedication") || "",
        synagogue: "Hadley Wood Shul"
      };

      userEmail = rec.email; // Store the user's email

      const savedMsg = document.getElementById("savedMsg");
      savedMsg.textContent = "Saving...";
      savedMsg.classList.remove("hidden", "text-green-600", "text-red-600");

      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(rec)
        });
        
        savedMsg.textContent = "Saved! Email Sent.";
        savedMsg.classList.add("text-green-600");

        // *** FIX START: Optimistically update local data immediately ***
        
        // Remove old booking for the same date if one existed locally (e.g. from previous attempt)
        bookings = bookings.filter(b => b.date !== rec.date); 
        
        // Add the new booking
        bookings.push({
          ...rec,
          amount:
            amountValue === "To be discussed with Chantel"
              ? amountLabel
              : `£${parseFloat(amountValue).toFixed(2)}`,
          email: rec.email
        });
        
        // Update local storage immediately
        localStorage.setItem("kiddushBookings", JSON.stringify(bookings));
        
        // Update the form box and clear selection
        formBox.innerHTML = `<div class='p-4 rounded-xl bg-green-50 text-green-800'>✅ Booking for <strong>${nice}</strong> reserved successfully! Updating calendar...</div>`;
        selected = null;
        
        // Immediately re-render calendar and bookings list with the optimistic local data
        renderCalendar(); 
        renderBookings(); 
        
        // *** FIX END ***


        // Then, after a short delay, fetch the live data to ensure accuracy
        setTimeout(() => {
          fetchBookings(); // Fetches live data to confirm and update cache
        }, 1500);
      } catch (err) {
        savedMsg.textContent = "Error: Booking failed to send. " + err.message;
        savedMsg.classList.add("text-red-600");
        reserveBtn.disabled = false;
        reserveBtn.textContent = "Reserve date";
      }
    };
  }
}

// ---------- DELETE BOOKING ----------

async function deleteBooking(date) {
  if (!userEmail) {
      alert("Error: Cannot remove booking without knowing your email address.");
      return;
  }
  
  const bookingToRemove = bookings.find(b => b.date === date);
  if (!bookingToRemove || bookingToRemove.email.toLowerCase() !== userEmail.toLowerCase()) {
      alert("Error: You can only remove your own booking.");
      return;
  }
  
  const nice = new Date(date).toLocaleDateString("en-GB", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric"
  });

  if (!confirm("Are you sure you want to remove your booking for " + nice + "? This action cannot be undone.")) return;
  
  document.querySelectorAll('#bookingsList button').forEach(btn => btn.disabled = true);
  
  try {
    const deleteUrl = `${SCRIPT_URL}?action=delete&date=${date}&email=${userEmail}`;
    await fetch(deleteUrl, { mode: "no-cors" });

    // Remove from local array immediately
    bookings = bookings.filter(b => b.date !== date);
    localStorage.setItem("kiddushBookings", JSON.stringify(bookings));
    
    // Re-render
    fetchBookings();
    alert("Booking successfully removed.");
  } catch (err) {
    alert("Delete failed. Please contact the office for assistance.");
    document.querySelectorAll('#bookingsList button').forEach(btn => btn.disabled = false);
  }
}

// ---------- MONTH NAV ----------

document.getElementById("prevBtn").onclick = () => {
  viewDate.setMonth(viewDate.getMonth() - 1);
  renderCalendar();
};

document.getElementById("nextBtn").onclick = () => {
  viewDate.setMonth(viewDate.getMonth() + 1);
  renderCalendar();
};

// ---------- INIT ----------

userEmail = localStorage.getItem("kiddushUserEmail") || null;

const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key, value) {
    if (key === "kiddushBookings" && selected) {
        const email = document.querySelector("#bookingForm input[name='email']")?.value?.toLowerCase();
        if (email) {
            originalSetItem.call(localStorage, "kiddushUserEmail", email);
            userEmail = email;
        }
    }
    originalSetItem.call(localStorage, key, value);
};


fetchBookings();
</script>
</body>
</html>
