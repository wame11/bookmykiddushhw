<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book My Kiddush — Hadley Wood Shul</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(to bottom,#eef2ff,white); }
    .card { background: rgba(255,255,255,0.85); backdrop-filter: saturate(1.2) blur(2px); }
    .chip { font-size: 10px; padding: .125rem .5rem; border-radius: 9999px; }
    #loading { display: none; text-align: center; padding: 1rem; color: #555; }
  </style>
</head>
<body class="text-gray-900">

<header class="sticky top-0 z-40 bg-white bg-opacity-70 backdrop-filter backdrop-blur border-b">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="#home" class="font-black tracking-tight text-xl">Book My Kiddush</a>
    <nav class="hidden md:flex gap-6 text-sm font-medium">
      <a href="#faq" class="hover:text-indigo-600">Key Information</a>
      <a href="#calendar" class="hover:text-indigo-600">Calendar</a>
      <a href="#contact" class="hover:text-indigo-600">Contact</a>
    </nav>
    <a href="#calendar" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700">Sponsor</a>
  </div>
</header>

<main id="home" class="relative overflow-hidden">
  <section class="max-w-6xl mx-auto px-4 py-16 md:py-24 grid md:grid-cols-2 gap-12 items-center">
    <div>
      <h1 class="text-4xl md:text-5xl font-extrabold leading-tight">Reserve your Kiddush date</h1>
      <p class="mt-4 text-lg text-gray-700">
        Select an available <strong>Shabbat</strong> or <strong>Festival</strong> date to sponsor the Kiddush at <strong>Hadley Wood Shul</strong>.
      </p>
      <div class="mt-6 flex flex-wrap gap-3">
        <a href="#calendar" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Open Calendar</a>
      </div>
    </div>
    <div class="p-4">
      <div class="aspect-video rounded-2xl border shadow-lg bg-white grid place-items-center">
        <p class="text-gray-600">Book your Kiddush date quickly and easily.</p>
      </div>
    </div>
  </section>
</main>

<section id="faq" class="max-w-6xl mx-auto px-4 py-16 border-t">
  <h2 class="text-2xl md:text-3xl font-bold mb-6">Key Information</h2>
  <div class="space-y-6 text-gray-700">
    <div><h3 class="font-semibold text-lg text-indigo-700">How do I book a Kiddush?</h3><p class="mt-1">Scroll down to the calendar, choose an available date, select your preferred sponsorship package, and complete the booking form.</p></div>
    <div><h3 class="font-semibold text-lg text-indigo-700">What about Bar/Bat Mitzvahs?</h3><p class="mt-1">By all means book your kiddush but please be aware there is a separate process for booking bar/bat mizvah celebrations through the office.</p></div>
    <div><h3 class="font-semibold text-lg text-indigo-700">Can I cancel or change my booking?</h3><p class="mt-1">Yes — if you booked with your email, you can remove your booking from the “Upcoming bookings” list, or contact the office for help.</p></div>
    <div><h3 class="font-semibold text-lg text-indigo-700">Who can see the amount I've sponsored?</h3><p class="mt-1">Only the Shul office.</p></div>
    <div><h3 class="font-semibold text-lg text-indigo-700">What if a date says “Booked”?</h3><p class="mt-1">That means it’s already taken — please select another available Shabbat or Festival date.</p></div>
  </div>
</section>

<section id="calendar" class="max-w-6xl mx-auto px-4 py-16 border-t">
  <h2 class="text-2xl md:text-3xl font-bold">Choose your date</h2>
  <p class="mt-2 text-gray-700">Only Saturdays and preset Festivals are available.</p>

  <div id="loading">Loading calendar...</div>

  <div class="mt-6 grid md:grid-cols-2 gap-8 items-start">
    <div class="card p-4 rounded-2xl border shadow-sm">
      <div class="flex items-center justify-between">
        <button id="prevBtn" class="px-3 py-2 rounded-lg border hover:bg-gray-50">Prev</button>
        <h3 id="monthLabel" class="text-lg font-semibold"></h3>
        <button id="nextBtn" class="px-3 py-2 rounded-lg border hover:bg-gray-50">Next</button>
      </div>
      <div class="grid grid-cols-7 gap-2 mt-4 text-sm text-center font-medium text-gray-600">
        <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
      </div>
      <div id="grid" class="grid grid-cols-7 gap-2 mt-2"></div>
    </div>

    <div class="space-y-6">
      <div id="formBox" class="card p-6 rounded-2xl border shadow-sm text-sm text-gray-700">
        <p>Select an available date to sponsor the Kiddush at <strong>Hadley Wood Shul</strong>.</p>
      </div>
      <div>
        <h3 class="text-lg font-semibold mb-2">Upcoming bookings</h3>
        <div id="bookingsList"></div>
      </div>
    </div>
  </div>
</section>

<section id="contact" class="max-w-6xl mx-auto px-4 py-16 border-t">
  <h2 class="text-2xl md:text-3xl font-bold mb-4">Contact</h2>
  <p class="text-gray-700 text-lg">
    For any questions or assistance, please contact
    <a href="mailto:office@hwjc.org.uk" class="text-indigo-600 hover:underline font-medium">office@hwjc.org.uk</a>.
  </p>
</section>

<script>
// CONFIG
const PROXY_URL = "https://corsproxy.io/?";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzqgikgNlCS59SzVoAZVY12QSvU716m869db2Y5IoriL4Q8-2et1PB3OYf7IiXfjxim/exec";

const FESTIVALS = new Set(["2025-04-13","2025-04-14","2025-04-19","2025-04-20","2025-06-02","2025-06-03","2025-09-23","2025-09-24","2025-10-07","2025-10-08","2025-10-14","2025-10-15"]);

let bookings = [];
let selected = null;
let viewDate = new Date();
let userEmail = null;

const grid = document.getElementById("grid");
const monthLabel = document.getElementById("monthLabel");
const formBox = document.getElementById("formBox");
const bookingsList = document.getElementById("bookingsList");
const loading = document.getElementById("loading");

// SAFE DATE HELPERS — NO TIMEZONE SHIFT EVER
const pad = n => n < 10 ? "0" + n : n;
const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const parseISO = str => { const [y,m,d] = str.split('-').map(Number); return new Date(y, m-1, d); };

// SIMPLE & BULLETPROOF CALENDAR MATRIX (Monday start)
function getDaysMatrix(date) {
  const year = date.getFullYear();
  const month = date.getMonth();
  const first = new Date(year, month, 1);
  const startOffset = (first.getDay() + 6) % 7; // Monday = 0
  const days = [];

  let current = new Date(year, month, 1 - startOffset);
  for (let i = 0; i < 42; i++) {
    days.push(new Date(current));
    current.setDate(current.getDate() + 1);
  }
  return days;
}

function isSelectable(d) {
  const iso = toISO(d);
  if (iso < toISO(new Date())) return false;
  return d.getDay() === 6 || FESTIVALS.has(iso); // Saturday = 6
}

// FETCH BOOKINGS
async function fetchBookings() {
  loading.style.display = "block";
  try {
    const res = await fetch(PROXY_URL + SCRIPT_URL);
    const data = await res.json();
    bookings = Array.isArray(data) ? data.map(b => ({...b, date: String(b.date).trim().split('T')[0]})) : [];
    localStorage.setItem("kiddushBookings", JSON.stringify(bookings));
  } catch (e) {
    const saved = localStorage.getItem("kiddushBookings");
    bookings = saved ? JSON.parse(saved) : [];
  }
  loading.style.display = "none";
  renderCalendar();
  renderBookings();
  if (selected) renderForm();
}

// RENDER CALENDAR — FIXED & SIMPLE
function renderCalendar() {
  monthLabel.textContent = viewDate.toLocaleString("en-GB", { month: "long", year: "numeric" });
  grid.innerHTML = "";

  const days = getDaysMatrix(viewDate);
  days.forEach(d => {
    const iso = toISO(d);
    const isThisMonth = d.getMonth() === viewDate.getMonth();
    const booking = bookings.find(b => b.date === iso);
    const taken = !!booking;
    const selectable = isSelectable(d) && isThisMonth && !taken;

    const cell = document.createElement("button");
    cell.disabled = !selectable;
    cell.className = `h-24 rounded-xl border flex flex-col items-center justify-center gap-1 ${selectable ? "bg-white hover:bg-indigo-50 cursor-pointer" : "bg-gray-50 text-gray-400"}`;

    cell.innerHTML = `
      <span class="text-base font-semibold">${d.getDate()}</span>
      <span class="text-[11px]">${iso}</span>
      ${taken ? `<span class="chip bg-red-100 text-red-700">Booked</span><span class="text-[10px] text-red-700">${booking.name}</span>` 
             : selectable ? `<span class="chip bg-green-100 text-green-700">Available</span>` : ""}
    `;

    if (selectable) cell.onclick = () => { selected = d; renderForm(); };
    grid.appendChild(cell);
  });
}

// RENDER UPCOMING BOOKINGS
function renderBookings() {
  bookingsList.innerHTML = bookings.length ? bookings.map(b => `
    <div class="p-4 rounded-xl border bg-white flex justify-between items-start">
      <div>
        <p class="font-semibold">${parseISO(b.date).toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'})} — ${b.name}</p>
        ${b.dedication ? `<p class="text-sm text-gray-600">${b.dedication}</p>` : ""}
      </div>
      ${userEmail === b.email ? `<button onclick="deleteBooking('${b.date}')" class="px-3 py-1 rounded border text-xs hover:bg-gray-50">Remove</button>` : ""}
    </div>`).join("") 
    : `<div class="p-4 rounded-xl bg-gray-50 border text-sm text-gray-600">No bookings yet.</div>`;
}

// FORM
function renderForm() {
  if (!selected) {
    formBox.innerHTML = "<p>Select an available date to sponsor the Kiddush at <strong>Hadley Wood Shul</strong>.</p>";
    return;
  }
  const iso = toISO(selected);
  const taken = bookings.some(b => b.date === iso);
  const niceDate = selected.toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'});

  formBox.innerHTML = `
    <div class="flex items-center justify-between"><h3 class="text-xl font-semibold">${niceDate}</h3><button id="changeDate" class="text-sm underline">Change</button></div>
    ${taken ? `<p class="mt-3 p-3 bg-red-50 border text-red-800 text-sm">This date is already booked.</p>` : ""}
    <form id="bookingForm" class="mt-4 grid md:grid-cols-2 gap-4">
      <div><label class="block text-sm font-medium">Full name</label><input required name="name" class="mt-1 w-full rounded-xl border px-3 py-2"></div>
      <div><label class="block text-sm font-medium">Email</label><input required type="email" name="email" class="mt-1 w-full rounded-xl border px-3 py-2"></div>
      <div><label class="block text-sm font-medium">Sponsorship Package</label>
        <select required name="amount" id="sponsorshipAmount" class="mt-1 w-full rounded-xl border px-3 py-2">
          <option value="">Select a package</option>
          <option value="200.00">Standard (£200)</option>
          <option value="325.00">Premium (£325)</option>
          <option value="To be discussed with Chantel">Special (Contact Office)</option>
        </select>
      </div>
      <div><label class="block text-sm font-medium">Synagogue</label><input disabled value="Hadley Wood Shul" class="mt-1 w-full rounded-xl border px-3 py-2 bg-gray-100"></div>
      <div class="md:col-span-2"><label class="block text-sm font-medium">Dedication (optional)</label><input name="dedication" class="mt-1 w-full rounded-xl border px-3 py-2"></div>
      <div class="md:col-span-2 flex gap-3">
        <button type="submit" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Reserve date</button>
        <span id="savedMsg" class="text-sm hidden"></span>
      </div>
    </form>
  `;

  document.getElementById("changeDate").onclick = () => { selected = null; renderForm(); };

  document.getElementById("bookingForm")?.addEventListener("submit", async e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const amount = document.getElementById("sponsorshipAmount").value;
    if (!amount) return alert("Please select a package");

    const rec = {
      date: iso,
      name: fd.get("name"),
      email: fd.get("email"),
      amount: amount === "To be discussed with Chantel" ? amount : parseFloat(amount).toFixed(2),
      dedication: fd.get("dedication") || "",
      synagogue: "Hadley Wood Shul"
    };
    userEmail = rec.email;

    const msg = document.getElementById("savedMsg");
    msg.textContent = "Saving..."; msg.classList.remove("hidden");

    try {
      await fetch(SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(rec) });
      msg.textContent = "Saved + Email Sent"; msg.classList.add("text-green-600");
      bookings.push(rec);
      localStorage.setItem("kiddushBookings", JSON.stringify(bookings));
      setTimeout(() => { selected = null; fetchBookings(); }, 1500);
    } catch (err) {
      msg.textContent = "Error"; msg.classList.add("text-red-600");
    }
  });
}

// DELETE
async function deleteBooking(date) {
  if (!confirm("Remove this booking?")) return;
  await fetch(`${SCRIPT_URL}?action=delete&date=${date}`, {mode:"no-cors"});
  bookings = bookings.filter(b => b.date !== date);
  localStorage.setItem("kiddushBookings", JSON.stringify(bookings));
  fetchBookings();
}
window.deleteBooking = deleteBooking;

// NAVIGATION
document.getElementById("prevBtn").onclick = () => { viewDate.setMonth(viewDate.getMonth()-1); renderCalendar(); };
document.getElementById("nextBtn").onclick = () => { viewDate.setMonth(viewDate.getMonth()+1); renderCalendar(); };

fetchBookings();
</script>
</body>
</html>
